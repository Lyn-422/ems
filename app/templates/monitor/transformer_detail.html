{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h3 class="mb-0">{{ room.room_name }} - 变压器监测详情</h3>
        <small class="text-muted">显示最新采集的实时遥测数据</small>
    </div>
    <div>
        <span class="badge bg-danger me-2">■ 运行异常/超温</span>
        <span class="badge bg-warning text-dark me-2">■ 数据缺失</span>
        <a href="{{ url_for('monitor.distribution_list') }}" class="btn btn-secondary btn-sm">
            <i class="fas fa-arrow-left"></i> 返回列表
        </a>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-hover table-bordered shadow-sm bg-white align-middle">
        <thead class="table-light text-center">
            <tr>
                <th style="width: 160px;">采集时间</th>
                <th>设备编号</th>
                <th>负载率</th>
                <th>本体温度<br><small class="text-muted">(绕组/铁芯)</small></th>
                <th>环境监测<br><small class="text-muted">(温度/湿度)</small></th>
                <th>运行状态</th>
                <th>数据校验</th>
            </tr>
        </thead>
        <tbody>
            {% for t in transformers %}
                {# 1. 定义逻辑变量 #}
                {# 判断数据缺失: 关键读数为 None #}
                {% set is_missing = (t.load_rate_percent is none) or (t.winding_temp_c is none) %}

                {# 判断异常: 状态不是'正常' 或者 绕组温度超过85度 #}
                {% set is_abnormal = (t.run_status != '正常') or (t.winding_temp_c and t.winding_temp_c > 85) %}

                {# 2. 行样式: 异常优先变红，其次缺失变黄 #}
                <tr class="text-center {{ 'table-danger' if is_abnormal else ('table-warning' if is_missing else '') }}">

                    <td>{{ t.collect_time.strftime('%Y-%m-%d %H:%M:%S') }}</td>

                    <td class="fw-bold">{{ t.transformer_code }}</td>

                    <td style="min-width: 120px;">
                        {% if t.load_rate_percent is not none %}
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar {{ 'bg-success' if t.load_rate_percent < 80 else 'bg-warning' }}"
                                     role="progressbar"
                                     style="width: {{ t.load_rate_percent }}%">
                                    {{ t.load_rate_percent }}%
                                </div>
                            </div>
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>

                    <td>
                        <div class="d-flex flex-column align-items-start ps-4">
                            {# 绕组温度: 高温则变红加粗 #}
                            {% if t.winding_temp_c and t.winding_temp_c > 85 %}
                                <span class="text-danger fw-bold"><i class="fas fa-temperature-high"></i> 绕组: {{ t.winding_temp_c }}℃</span>
                            {% else %}
                                <span >绕组: {{ t.winding_temp_c if t.winding_temp_c is not none else '-' }}℃</span>
                            {% endif %}

                            {# 铁芯温度 #}
                            <span >铁芯: {{ t.core_temp_c if t.core_temp_c is not none else '-' }}℃</span>
                        </div>
                    </td>

                    <td>
                        <div class="d-flex flex-column align-items-start ps-4">
                            <span >室温: {{ t.env_temp_c if t.env_temp_c is not none else '-' }}℃</span>
                            <span >湿度: {{ t.env_humidity if t.env_humidity is not none else '-' }}%</span>
                        </div>
                    </td>

                    <td>
                        {% if t.run_status == '正常' %}
                            <span class="badge rounded-pill bg-success">● 正常</span>
                        {% else %}
                            <span class="badge rounded-pill bg-danger">● {{ t.run_status }}</span>
                        {% endif %}
                    </td>

                    <td>
                        {% if is_abnormal %}
                            <span class="badge bg-danger">
                                <i class="fas fa-exclamation-triangle"></i> 数据异常
                            </span>
                        {% elif is_missing %}
                            <span class="badge bg-warning text-dark">
                                <i class="fas fa-question-circle"></i> 数据不完整
                            </span>
                        {% else %}
                            <span class="badge bg-success">
                                <i class="fas fa-check-circle"></i> 正常
                            </span>
                        {% endif %}
                    </td>
                </tr>
            {% else %}
                <tr>
                    <td colspan="7" class="text-center py-4 text-muted">
                        暂无变压器监测数据
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}