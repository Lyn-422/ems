{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold text-dark mb-1">
                <i class="bi bi-bar-chart-line-fill text-primary me-2"></i>
                {{ year }}å¹´ ç¬¬{{ period_value }}{{ 'æœˆ' if period_type == 'month' else 'å­£åº¦' }}å…¨å‚èƒ½è€—åˆ†ææŠ¥å‘Š
            </h3>
            <p class="text-muted small mb-0">å¤šç»´åº¦äº¤å‰é€è§†ï¼šè·¨å‚åŒºæˆæœ¬å¯¹æ¯”ã€èƒ½æºç»“æ„å æ¯”åˆ†æ</p>
        </div>
        <div class="btn-group shadow-sm">
            <button class="btn btn-outline-primary btn-sm" onclick="window.print()"><i class="bi bi-printer me-1"></i>æ‰“å°æŠ¥å‘Š</button>
            <button class="btn btn-primary btn-sm"><i class="bi bi-file-earmark-excel me-1"></i>å¯¼å‡ºæ•°æ®</button>
        </div>
    </div>

    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <form class="row g-3 align-items-end">
                <div class="col-md-2">
                    <label class="form-label small fw-bold text-muted">å¹´åº¦</label>
                    <input type="number" name="year" class="form-control border-0 bg-light" value="{{ year }}">
                </div>
                <div class="col-md-2">
                    <label class="form-label small fw-bold text-muted">ç»Ÿè®¡ç»´åº¦</label>
                    <select name="period_type" id="p_type" class="form-select border-0 bg-light">
                        <option value="month" {% if period_type=='month' %}selected{% endif %}>ğŸ“… æŒ‰æœˆä»½</option>
                        <option value="quarter" {% if period_type=='quarter' %}selected{% endif %}>ğŸ§± æŒ‰å­£åº¦</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label small fw-bold text-muted">é€‰æ‹©å‘¨æœŸ</label>
                    <select name="period_value" id="p_val" class="form-select border-0 bg-light"></select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100 fw-bold">ç”Ÿæˆåˆ†ææŠ¥å‘Š</button>
                </div>
            </form>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-lg-5">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 fw-bold pt-3"><i class="bi bi-pie-chart text-warning me-2"></i>æˆæœ¬ç»“æ„å æ¯”</div>
                <div class="card-body">
                    <div id="costPieChart" style="height: 350px;"></div>
                </div>
            </div>
        </div>
        <div class="col-lg-7">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 fw-bold pt-3"><i class="bi bi-hdd-stack text-success me-2"></i>å„å‚åŒºæˆæœ¬å¯¹æ¯” (CNY)</div>
                <div class="card-body">
                    <div id="plantBarChart" style="height: 350px;"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-0 fw-bold pt-3">ç»è¥æ•°æ®æ˜ç»† (è·¨èƒ½æºé€è§†)</div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0 text-center">
                    <thead class="table-light">
                        <tr class="small text-muted">
                            <th class="ps-4 text-start">å‚åŒºåç§°</th>
                            <th>èƒ½æºç±»å‹</th>
                            <th>å‘¨æœŸæ€»è€—ç”¨</th>
                            <th class="pe-4 text-end">å‘¨æœŸæ€»æˆæœ¬ (CNY)</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for row in results %}
                        <tr>
                            <td class="ps-4 text-start fw-bold text-dark">{{ row[0] }}</td>
                            <td>
                                {% set e_names = {'electric':'âš¡ ç”µåŠ›', 'water':'ğŸ’§ æ°´', 'gas':'ğŸ”¥ å¤©ç„¶æ°”', 'steam':'ğŸ’¨ è’¸æ±½'} %}
                                <span class="badge bg-light text-dark border fw-normal">{{ e_names.get(row[1]) }}</span>
                            </td>
                            <td>{{ "%.2f"|format(row[2]) }}</td>
                            <td class="pe-4 text-end fw-bold text-danger">
                                <span class="small">Â¥</span> {{ "%.2f"|format(row[3]) }}
                            </td>
                        </tr>
                    {% else %}
                        <tr><td colspan="4" class="py-5 text-muted">æš‚æ— ç›¸å…³ç»è¥æ•°æ®</td></tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script>
// ==================== 1. åˆå§‹åŒ–é¥¼å›¾ (æˆæœ¬ç»“æ„) ====================
var pieChart = echarts.init(document.getElementById('costPieChart'));
pieChart.setOption({
    tooltip: { trigger: 'item', formatter: '{b}: Â¥{c} ({d}%)' },
    legend: { bottom: '5%', left: 'center' },
    series: [{
        name: 'æˆæœ¬å æ¯”',
        type: 'pie',
        radius: ['40%', '70%'],
        avoidLabelOverlap: false,
        itemStyle: { borderRadius: 10, borderColor: '#fff', borderWidth: 2 },
        label: { show: false },
        emphasis: { label: { show: true, fontSize: '16', fontWeight: 'bold' } },
        data: {{ chart_data.cost_pie | tojson }}
    }]
});

// ==================== 2. åˆå§‹åŒ–æŸ±çŠ¶å›¾ (å‚åŒºå¯¹æ¯”) ====================
// ä¿®å¤ç‚¹ï¼šæ·»åŠ åŸæœ¬ç¼ºå¤±çš„æŸ±çŠ¶å›¾åˆå§‹åŒ–è„šæœ¬
var barChart = echarts.init(document.getElementById('plantBarChart'));
barChart.setOption({
    tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' }, formatter: '{b}: Â¥{c}' },
    grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
    xAxis: {
        type: 'category',
        data: {{ chart_data.plants | tojson }},  // åç«¯éœ€è¿”å› report_data["plants"]
        axisTick: { alignWithLabel: true }
    },
    yAxis: { type: 'value', name: 'æˆæœ¬ (å…ƒ)' },
    series: [{
        name: 'æ€»æˆæœ¬',
        type: 'bar',
        barWidth: '40%',
        data: {{ chart_data.plant_costs | tojson }}, // åç«¯éœ€è¿”å› report_data["plant_costs"]
        itemStyle: {
            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                { offset: 0, color: '#83bff6' },
                { offset: 0.5, color: '#188df0' },
                { offset: 1, color: '#188df0' }
            ]),
            borderRadius: [5, 5, 0, 0]
        },
        label: { show: true, position: 'top', formatter: 'Â¥{c}' }
    }]
});

// ==================== 3. ä¸‹æ‹‰æ¡†è”åŠ¨ä¸å“åº”å¼ ====================
function updateOptions() {
    const type = document.getElementById('p_type').value;
    const valSelect = document.getElementById('p_val');
    valSelect.innerHTML = '';
    const count = type === 'month' ? 12 : 4;
    const label = type === 'month' ? 'æœˆ' : 'å­£åº¦';
    for (let i = 1; i <= count; i++) {
        valSelect.add(new Option(i + label, i));
    }
    valSelect.value = "{{ period_value }}";
}

document.getElementById('p_type').addEventListener('change', updateOptions);
window.addEventListener('resize', function() {
    pieChart.resize();
    barChart.resize();
});
updateOptions();
</script>

<style>
    .bg-light { background-color: #f8f9fa !important; }
    .table th { font-weight: 600; background-color: #f8f9fa; }
</style>
{% endblock %}